---
title: "Introduction"
subtitle: "The multilevel hidden Markov model"
author: "Dr. Emmeke Aarts [e.aarts@uu.nl] <br> Pre-conference workshop for the International Conference on Multilevel Analysis "
date: "March 11, 2024"
output: 
  ioslides_presentation:
    css: style.css
    widescreen: true
    incremental: true
    logo: UU_logo_EN_CMYK.png
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(mHMMbayes)
```


## Intense longitudinal data (ILD)

<div style = "float: left; width: 60%;">
Uniquely suited to provide detailed information on psychological and behavioral processes over time at the within-person level 

- Daily Diary
- Ecological momentary assessment (EMA)
- Experience sampling method (ESM)
- Ambulatory assessments (AA)
- Sensors

54 publications indexed on PubMed in 2000, rising to 984 and 1203 publications in 2020 and 2021.
</div>
<div style = "float: right; width: 40%;">
<div align="left">
<br>
<br>
<img src="./figures/ESM_noun.png" width=300>
</div>
</div>



---

<div align="center">
<br>
<br>
<font size="10">Empirical example I
<br>
<br>
Capturing (suicidal) crisis dynamics </font>
</div>

## Capturing crisis dynamics using ESM data

<div align="center">
<br>
<img src="./figures/CAB data.png" width=950>
</div>

- 26 patients, 60 observations per patient per CAB factor


## Analyzing ILD data 

Most popular statistical models for (emotion) time series:

- the (multilevel) vector autoregressive (VAR) model
- multilevel linear regression model 

Statistical concern: multimodality and skewness are highly prevalent: "less than half of emotion measurements (14%â€“40% across studies) exhibited a unimodal symmetric distribution" (Haslbeck et al., 2023).

Suggests the presence of multiple states, and the need for time series models that accommodates multimodality, such as hidden Markov models. 


## Theory driven preference for HMMs

Current repeated measures and time series models aggregate across time points

However, we want to infer: 

- The dynamics over time in CAB crisis states
- Distinct and ascending latent CAB crisis states over time 
- The composition of the latent, multidimensional CAB crisis states
- How much patients differ in their dynamics over time
- Patient specific CAB crisis trajectories over time

## The hidden Markov model {.smaller}

<div align="center">
<img src="./figures/HMM illustration_stats CAB.png" width=1000>
</div>

HMM: probabilistic model to infer hidden states $S_t \in (1, 2, ..., m)$ at 

- each time point $t = 1, 2, ..., T$ 
- from the observed series $(y_{k1}, y_{k2}, ..., y_{kT})$ 
- for dependent variable $k = 1, 2, ..., K$

## The hidden Markov model {.smaller}

<div align="center">
<img src="./figures/HMM illustration_stats CAB.png" width=1000>
</div>

We assume:

- observation $y_{kt}$ is generated by an underlying, latent state $S_t$, 
- sequence of hidden states $\{S_t : t = 1, 2, ..., T\}$ forms a Markov chain: probability of switching to the next state $S_{t+1}$ only depends on the current state $S_t$: $P(S_{t_1} | S_t, S_{t-1}, ..., S_1 = P(S_{t+1} | S_t)$

## The hidden Markov model {.smaller}

<div align="center">
<img src="./figures/HMM illustration_stats CAB.png" width=1000>
</div>


Two sets of parameters: 

1) probability of transitioning between latent states $\gamma_{ij}=P(S_{t+1} = j | S_t = i)$  
2) probability of emitting an observation given the current latent state $P(y_{kt} | S_t)$


## The hidden Markov model {.smaller}

<div align="center">
<img src="./figures/HMM illustration_stats CAB.png" width=1000>
</div>

Given example data, assume 

- Normal emission distribution: $P(y_{kt} | S_t) \sim N(\mu_{ki}, \sigma_{ki}^2)$
- $y_{k.}$ are conditionally independent given $\{S_t : t = 1, 2, ..., T\}$ to accommodate multivariate data

## HMM is suited for one sequence of data
Analyzing data from multiple individuals: 

- fit HMM to the data of each individual separately
- fit one and the same HMM model to the data of all individuals 
    - strong assumption: subjects do not differ with respect to HMM parameters 
- explain some of the differences using covariates (e.g., R package depmixS4)

- Does not allow (quantification of) natural variation (i.e., heterogeneity) between individuals
- Does not allow for individual specific dynamics over time

## Extending the HMM to a multilevel framework
Including a multilevel framework for the HMM, enables simultaneous estimation:

- group level parameter estimates 
- subject specific parameter estimates for each subject $n$ 

Multinomial logistic regression to estimate transition probabilities $\gamma_{nij}$ 

$\gamma_{nij} = \frac{\text{exp}(\alpha_{nij})}{1 + \sum_{{j} = 2}^m \text{exp}(\alpha_{ni{j}})} \quad$ where $\quad \alpha_{nij} = \bar{\alpha}_{ij} + \epsilon_{\left[\alpha\right]nij}$

In addition, for the variable & state dependent emission Normal means:

$\quad {\mu_{nki} = \bar{\mu}_{ki} + \epsilon_{\left[\mu\right]nki}}$

Adopt a Bayesian approach



## Four CAB based crisis states
<div align="center">
<br>
<br>
<img src="./figures/Emissions - group and patient.png" width=850>
</div>

## CAB crisis state dynamics 

<div align="center">
<br>
<img src="./figures/transitions - group and patient.png" width=850>
</div>

## Personalized crisis trajectories 

<div align="center">
<br>
<img src="./figures/Cab trajectories selected.png" width=850>
</div>

## Capturing crisis dynamics -- conclusion 

Pairing fine grained ESM data with multilevel HMM, we

- Identified four distinct and ascending CAB based crisis states
- Quantified and visualized the pattern of crisis at the group and patient individual level
- Observed considerable variation between patients, both in remaining within and transitioning between CAB crisis states
- Highlighted the need for a personalized method 


---

<div align="center">
<br>
<br>
<font size="10">Empirical example II
<br>
<br>
Nonverbal interpersonal interaction in patient-therapist dyads </font>
</div>


## Interaction in patient-therapist dyads

39 patient-therapist dyads

15 min annotated video recordings of therapy session

<div align="center">
<img src="./figures/example interaction data.png" width=730>
</div>

## Possible research questions

- Can we extract latent interpersonal interaction states over time? 
- What are the dynamics over time in interpersonal interaction states? 
- Do patient-therapist dyads differ in their dynamics over time? 
- Can this between dyad heterogeneity be explained by, for example, depression improvement? 

## The hidden Markov model {.smaller}

<div align="center">
<img src="figures/HMM illustration_stats V2.png" width=1000>
</div>

HMM: probabilistic model to infer hidden states $S_t \in (1, 2, ..., m)$ at 

- each time point $t = 1, 2, ..., T$ 
- from the observed series $(y_{k1}, y_{k2}, ..., y_{kT})$ 
- for dependent variable $k = 1, 2, ..., K$

## The hidden Markov model {.smaller}

<div align="center">
<img src="figures/HMM illustration_stats V2.png" width=1000>
</div>

We assume:

- observation $y_{qt}$ is generated by an underlying, latent state $S_t$, 
- sequence of hidden states $\{S_t : t = 1, 2, ..., T\}$ forms a Markov chain: probability of switching to the next state $S_{t+1}$ only depends on the current state $S_t$: $P(S_{t_1} | S_t, S_{t-1}, ..., S_1 = P(S_{t+1} | S_t)$

## The hidden Markov model {.smaller}

<div align="center">
<img src="figures/HMM illustration_stats V2.png" width=1000>
</div>


Two sets of parameters: 

1) probability of transitioning between latent states $\gamma_{ij}=P(S_{t+1} = j | S_t = i)$  
2) probability of emitting an observation given the current latent state $P(y_{kt} | S_t)$


## The hidden Markov model {.smaller}

<div align="center">
<img src="figures/HMM illustration_stats V2.png" width=1000>
</div>

Given example data, assume 

- categorical emission distribution: $P(y_{kt} | S_t) \sim Cat(\theta_{ki})$
- $y_{k.}$ are conditionally independent given $\{S_t : t = 1, 2, ..., T\}$ to accommodate multivariate data

## Three nonverbal communication states

<div align="center">
<img src="./figures/State composition V2.png" width=650>
</div>

## Dynamics in nonverbal communication 

<div align="center">
<br>
<img src="./figures/State dynamics.png" width=450>
</div>


## Explaining heterogeneity - including covariate(s)

<div align="center">
<br>
<img src="./figures/Predicted and observed transition probabilities.png" width=800>
</div>

## Predicted nonverbal state dynamics

<div align="center">
<br>
<img src="./figures/predicted state dynamics new - reduced.png" width=900>
</div>

## Predicted nonverbal state dynamics

<div align="center">
<br>
<img src="./figures/predicted state dynamics new.png" width=900>
</div>

## Most likely nonverbal communication state sequences

<div align="center">
<br>
<img src="./figures/predicted states new.png" width=950>
</div>


## Interaction in patient-therapist dyads - conclusion


---

<div align="center">
<br>
<br>
<font size="10"> mHMMbayes
<br>
<br>
R package for multilevel hidden Markov models using Bayesian estimation </font>
</div>


## mHMMbayes

- mHMMbayes fits multilevel hidden Markov models using Bayesian estimation 
- Allows for heterogeneity between subjects, while estimating one overall HMM
- The model accommodates  
    - continuous, categorical and count multivariate data  
    - individual level covariates  
    - missing data in the dependent variable(s)
- The package also includes functions for automated plotting, simulating data, and obtaining the most likely hidden state sequence for each individual using the Viterbi algorithm. 

## mHMMbayes - Bayesian estimation 

Advantages:

- Bayesian methods yield many additional metrics, such as standard errors and credibility intervals, much harder to extract using frequentist methods.
- Relatively easy to handle missing data (assuming MAR).
- Allowing incorporation of prior knowledge (through prior distribution specification) accommodates smaller sample sizes. 
- Adds flexibility, making it relatively easy to extent to more complex models. 


## mHMMbayes - Metropolis within Gibbs sampler

1. Obtain forward probabilities $\alpha_{t(ni)} = Pr\big(O_1 = o_1, ..., O_t = o_t, S_t = i\big)$ for each subject using current values of subject specific model parameters.
2. Sample hidden state sequences in backward manner using $\alpha_{t(ni)}$ and $\gamma_{nij}$.
3. Given current subject-specific parameters, draw new group-level parameter estimates using Gibbs step
4. Given 
    - observed event sequence for each subject
    - sampled hidden state sequence for each subject
    - group-level parameter distributions
    - draw new subject-specific parameters using Random Walk (RW) Metropolis sampler
5. Repeat step 1-4 a very large number of times

## The mHMMbayes package: an example

39 patient-therapist dyads

15 min annotated video recordings of therapy session

<div align="center">
<img src="figures/example interaction data.png" width=730>
</div>

## Fitting a simple model - input

Fitting a 3 state multilevel hidden Markov model on the nonverbal data: 

```{r settings and load 2 state model, include = FALSE}
library(mHMMbayes)
## specifying general model properties:
m <- 3     # number of hidden states
n_dep <- 6     # number of dependent input variables
q_emiss <- c(3, 2, 2, 3, 2, 2)   # number of categories within each dep var

# specifying starting values
start_TM <- diag(.9, m)
start_TM[lower.tri(start_TM) | upper.tri(start_TM)] <- .05
start_EM <- list(matrix(c(0.70, 0.20, 0.10, # vocalizing therapist
                           0.05, 0.90, 0.05,
                           0.25, 0.70, 0.05), byrow = TRUE, nrow = m, ncol = q_emiss[1]), 
                  matrix(c(0.15, 0.85, # looking therapist
                           0.35, 0.65,
                           0.30, 0.70), byrow = TRUE, nrow = m, ncol = q_emiss[2]), 
                  matrix(c(0.80, 0.20, # leg therapist
                           0.80, 0.20,
                           0.80, 0.20), byrow = TRUE, nrow = m, ncol = q_emiss[3]), 
                  matrix(c( 0.10, 0.80, 0.10, # vocalizing patient
                            0.90, 0.05, 0.05,
                           0.85, 0.05, 0.10), byrow = TRUE, nrow = m, ncol = q_emiss[4]), 
                  matrix(c(0.30, 0.70, # looking patient
                           0.10, 0.90,
                           0.50, 0.50), byrow = TRUE, nrow = m, ncol = q_emiss[5]), 
                  matrix(c(0.70, 0.30, # leg patient
                           0.90, 0.10,
                           0.35, 0.65), byrow = TRUE, nrow = m, ncol = q_emiss[6])) 

out_3st <- readRDS("./out_vll_3st.rds")
out_3st 
```

```{r show specifying 2 state model, eval = FALSE, echo=TRUE}
library(mHMMbayes)

## specifying general model properties:
 # number of states m
m <- 3
 # number of dependent variables
n_dep <- 6
 # number of output categories for each dependent var
q_emiss <- c(3, 2, 2, 3, 2, 2) 

``` 

## Fitting a simple model - input
```{r, echo = TRUE}
## specifying starting values
 # Start values of the TPM
start_TM <- diag(.9, m)
start_TM[lower.tri(start_TM) | upper.tri(start_TM)] <- .05

 # Start values for the emission distribution
start_EM <- list(matrix(c(0.70, 0.20, 0.10, # vocalizing therapist
                           0.05, 0.90, 0.05,
                           0.25, 0.70, 0.05), byrow = TRUE, nrow = m, ncol = q_emiss[1]), 
                  matrix(c(0.15, 0.85, # looking therapist
                           0.35, 0.65,
                           0.30, 0.70), byrow = TRUE, nrow = m, ncol = q_emiss[2]), 
                  matrix(c(0.80, 0.20, # leg therapist
                           0.80, 0.20,
                           0.80, 0.20), byrow = TRUE, nrow = m, ncol = q_emiss[3]) 
                  # continue emission probs here for the three other variables
                 ) 
```

## Fitting a simple model - input
```{r show fitting 2 state model, eval = FALSE, echo=TRUE}
# Run a model without covariate(s) and default priors:
out_3st <- mHMM(s_data = MHMM_nonverbal,
                data_distr = "categorical",
                gen = list(m = m, n_dep = n_dep, q_emiss = q_emiss),
                start_val = c(list(start_TM), start_EMc),
                mcmc = list(J = J, burn_in = burn_in))

```

## Model output - print()
```{r, echo=TRUE}
out_3st
```



## Model output - summary()
```{r, echo=TRUE}
summary(out_3st)
```


## State composition - obtain_emiss()
```{r, echo=TRUE}
emiss_pop <- obtain_emiss(out_3st)
emiss_pop
```

## State dynamics - obtain_gamma()
```{r, echo=TRUE}
gamma_pop <- obtain_gamma(out_3st)
gamma_pop
```

## State dynamics at dyad level - obtain_gamma()
```{r, echo=TRUE}
gamma_subj <- obtain_gamma(out_3st, level = "subject")
gamma_subj
```

## References 

- <font size="3">J. Haslbeck, O. Ryan, & F. Dablander (2023). Multimodality and skewness in emotion time series. Emotion, 23(8), 2117â€“2141.  Doi: 10.1037/emo0001218 </font>
- <font size="3">W. W. Hale III, & **E. Aarts** (2023). Hidden Markov model detection of interpersonal interaction dynamics in predicting patient depression improvement in psychotherapy: Proof-of-concept study. Journal of Affective Disorders Reports, 14, 100635. Doi: 10.1016/j.jadr.2023.100635 </font>
- <font size="3">S. Mildiner Moraga, F.M. Bos, B. Doornbos, R. Bruggeman, L. van der Krieke, E. Snippe, **E. Aarts** (2022). Evidence for severe mood instability in patients with bipolar disorder: Applying multilevel hiden Markov modelling to intensive longitudinal ecological momentary assessment data. PsyArXiv preprint. Doi: 10.31234/osf.io/egp82 </font>
- <font size="3">Mildiner Moraga, S., & **Aarts, E.** (2023). Go Multivariate: Recommendations on Bayesian Multilevel Hidden Markov Models with Categorical Data. Multivariate Behavioral Research, 1-29. Doi: 10.1080/00273171.2023.2205392 </font>
