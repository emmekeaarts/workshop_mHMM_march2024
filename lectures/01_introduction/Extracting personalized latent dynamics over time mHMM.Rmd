---
title: "Capturing crisis dynamics"
subtitle: "A personalized approach using multilevel hidden Markov models"
author: "Dr. Emmeke Aarts, Dr. Muriel Hagenaars <br>  [e.aarts@uu.nl] <br><br> Project with Barbara Montage and Thomas J. van der Meer"
date: "October 5, 2023"
output: 
  ioslides_presentation:
    css: style.css
    widescreen: true
    incremental: true
    logo: UU_logo_EN_CMYK.png
---

## Capturing (suicidal) crisis dynamics

Suicidal crises:

- Common phenomenon in treatment of severe psychological disorders
- Multidimensional: interplay of cognitive, affective, and behavioral (CAB) symptoms
- Dynamic, time-varying 
- Large between patient heterogeneity 

In need of a comprehensive framework that accommodates the multidimensionality, time-varying nature, and between patient heterogeneity.


## Intense longitudinal data (ILD)

<div style = "float: left; width: 60%;">
Uniquely suited to provide detailed information on psychological processes over time at the within-person level 

- Daily Diary
- Ecological momentary assessment (EMA)
- Experience sampling method (ESM)
- Ambulatory assessments (AA)
- Sensors
</div>
<div style = "float: right; width: 40%;">
<div align="left">
<br>
<br>
<img src="figures/ESM_noun.png" width=300>
</div>
</div>

## Capturing crisis dynamics using ESM data

<div align="center">
<br>
<img src="figures/CAB data.png" width=950>
</div>

- 26 patients, 60 observations per patient per CAB factor

## Possible research questions

Current repeated measures and time series models aggregate across time points

However, we want to infer: 

- Distinct and ascending latent CAB crisis states over time 
- The dynamics over time in these CAB crisis states
- The composition of the latent, multidimensional CAB crisis states
- How much patients differ in their dynamics over time
- Patient specific CAB crisis trajectories over time



## The hidden Markov model {.smaller}

<div align="center">
<img src="figures/HMM illustration_stats CAB.png" width=1000>
</div>

HMM: probabilistic model to infer hidden states $S_t \in (1, 2, ..., m)$ at 

- each time point $t = 1, 2, ..., T$ 
- from the observed series $(y_{k1}, y_{k2}, ..., y_{kT})$ 
- for dependent variable $k = 1, 2, ..., K$

## The hidden Markov model {.smaller}

<div align="center">
<img src="figures/HMM illustration_stats CAB.png" width=1000>
</div>

We assume:

- observation $y_{kt}$ is generated by an underlying, latent state $S_t$, 
- sequence of hidden states $\{S_t : t = 1, 2, ..., T\}$ forms a Markov chain: probability of switching to the next state $S_{t+1}$ only depends on the current state $S_t$: $P(S_{t_1} | S_t, S_{t-1}, ..., S_1 = P(S_{t+1} | S_t)$

## The hidden Markov model {.smaller}

<div align="center">
<img src="figures/HMM illustration_stats CAB.png" width=1000>
</div>


Two sets of parameters: 

1) probability of transitioning between latent states $\gamma_{ij}=P(S_{t+1} = j | S_t = i)$  
2) probability of emitting an observation given the current latent state $P(y_{kt} | S_t)$


## The hidden Markov model {.smaller}

<div align="center">
<img src="figures/HMM illustration_stats CAB.png" width=1000>
</div>

Given example data, assume 

- Normal emission distribution: $P(y_{kt} | S_t) \sim N(\mu_{ki}, \sigma_{ki}^2)$
- $y_{k.}$ are conditionally independent given $\{S_t : t = 1, 2, ..., T\}$ to accommodate multivariate data

## HMM is suited for one sequence of data
Analyzing data from multiple individuals: 

- fit HMM to the data of each individual separately
- fit one and the same HMM model to the data of all individuals 
    - strong assumption: subjects do not differ with respect to HMM parameters 
- explain some of the differences using covariates (e.g., R package depmixS4)

- Does not allow (quantification of) natural variation (i.e., heterogeneity) between individuals
- Does not allow for individual specific dynamics over time

## Extending the HMM to a multilevel framework
Including a multilevel framework for the HMM, enables simultaneous estimation:

- group level parameter estimates 
- subject specific parameter estimates for each subject $n$ 

Adopt a Bayesian approach


## Four CAB based crisis states
<div align="center">
<br>
<br>
<img src="figures/Emissions - group and patient.png" width=850>
</div>

## Assuring equivalent state meaning over patients 

<div align="center">
<br>
<img src="figures/State_comp_patient_selection.png" width=850>
</div>

## CAB crisis state dynamics 

<div align="center">
<br>
<img src="figures/transitions - group and patient.png" width=850>
</div>

## Personalized crisis trajectories 

<div align="center">
<br>
<img src="figures/Cab trajectories selected.png" width=850>
</div>



## Wrap up

Pairing fine grained ESM data with multilevel HMM, we

- Identified four distinct and ascending CAB based crisis states
- Quantified and visualized the pattern of crisis at the group and patient individual level
- Observed considerable variation between patients, both in remaining within and transitioning between CAB crisis states
- Highlighted the need for a personalized method 

## mHMMbayes R CRAN package

mHMMbayes: multilevel hidden Markov models using Bayesian estimation 

- Allows for heterogeneity between subjects, while estimating one overall HMM
- The model accommodates  
    - continuous and categorical multivariate data  
    - individual level covariates  
    - missing data in the dependent variable(s)
- The package also includes functions for automated plotting, simulating data, and obtaining the most likely hidden state sequence for each individual using the Viterbi algorithm. 


## Thank you for your attention!





<br>
<br>

Questions? -> E.Aarts\@uu.nl

<br>
<br>
<br>
<br>
<br>
<br>
<br>

<font size="4"> https://cran.r-project.org/web/packages/mHMMbayes </font>

## More on multilevel HMM 

- <font size="3">W. W. Hale III, & **E. Aarts** (2023). Hidden Markov model detection of interpersonal interaction dynamics in predicting patient depression improvement in psychotherapy: Proof-of-concept study. Journal of Affective Disorders Reports, 14, 100635. Doi: 10.1016/j.jadr.2023.100635 </font>
- <font size="3">S. Mildiner Moraga, F.M. Bos, B. Doornbos, R. Bruggeman, L. van der Krieke, E. Snippe, **E. Aarts** (2022). Evidence for severe mood instability in patients with bipolar disorder: Applying multilevel hiden Markov modelling to intensive longitudinal ecological momentary assessment data. PsyArXiv preprint. Doi: 10.31234/osf.io/egp82 </font>
- <font size="3">Mildiner Moraga, S., & **Aarts, E.** (2023). Go Multivariate: Recommendations on Bayesian Multilevel Hidden Markov Models with Categorical Data. Multivariate Behavioral Research, 1-29. Doi: 10.1080/00273171.2023.2205392 </font>

## Extending the HMM to a multilevel framework
Including a multilevel framework for the HMM, enables simultaneous estimation:

- group level parameter estimates 
- subject specific parameter estimates for each subject $n$ 

Multinomial logistic regression to estimate transition probabilities $\gamma_{nij}$ 

$\gamma_{nij} = \frac{\text{exp}(\alpha_{nij})}{1 + \sum_{{j} = 2}^m \text{exp}(\alpha_{ni{j}})} \quad$ where $\quad \alpha_{nij} = \bar{\alpha}_{ij} + \epsilon_{\left[\alpha\right]nij}$

In addition, for the variable & state dependent emission Normal means:

$\quad {\mu_{nki} = \bar{\mu}_{ki} + \epsilon_{\left[\mu\right]nki}}$

Adopt a Bayesian approach

## mHMMbayes - Metropolis within Gibbs sampler

1. Obtain forward probabilities $\alpha_{t(ni)} = Pr\big(O_1 = o_1, ..., O_t = o_t, S_t = i\big)$ for each subject using current values of subject specific model parameters.
2. Sample hidden state sequences in backward manner using $\alpha_{t(ni)}$ and $\gamma_{nij}$.
3. Given current subject-specific parameters, draw new group-level parameter estimates using Gibbs step
4. Given 
    - observed event sequence for each subject
    - sampled hidden state sequence for each subject
    - group-level parameter distributions
    - draw new subject-specific parameters using Random Walk (RW) Metropolis sampler
5. Repeat step 1-4 a very large number of times

## Details 3: determining number of states 

Table 1. Model fit and convergence indices.

+----------------------------+---------------+---------------+---------------+---------------+
|                            | 2 state model | 3 state model | 4 state model | 5 state model |
+============================+===============+===============+===============+===============+
| AIC                        | 2663          | 2632          | 2621          | 2621          |
+----------------------------+---------------+---------------+---------------+---------------+
| Mean Rhat (\% > 1.2)       |               |               |               |               |
+----------------------------+---------------+---------------+---------------+---------------+
| State transition           | 1.04 (0.0\%)  | 1.02 (0.0\%)  | 1.01 (0.0\%)  | 1.01 (0.0\%)  |
| parameters                 |               |               |               |               |
+----------------------------+---------------+---------------+---------------+---------------+
| State composition          | 1.04 (0.0\%)  | 1.04 (0.1\%)  | 1.01 (0.0\%)  | 1.03 (0.0\%)  |
| parameters                 |               |               |               |               |
+----------------------------+---------------+---------------+---------------+---------------+


